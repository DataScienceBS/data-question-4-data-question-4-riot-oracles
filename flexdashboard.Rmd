---
title: "Flexdashboard"
author: "Brandon Sanders"
date: "2/13/2018"
output:
    flexdashboard::flex_dashboard:
    orientation: rows

---

<!--- This R markdown file was created as part of the Nashville Software School, Data Science Cohort 01. 
The task was to take IRS 2014-2015 data for the state of Tennessee, and state high school academic achievement scores to gather insight, identify relationships or correlations, and report as a data journalist and communicate with an audience at an 8th grade level  --->

```{r reading_data, include=FALSE}
knitr::opts_chunk$set(include = TRUE)
combined_df <- readRDS("combined_df.RDS")  # BS
farm_map <- readRDS("farm_map.RDS")  # BS
school_cross <- readRDS("school_cross.RDS") # BS  
merged_df <- readRDS("data/merged_df.rds") # Justin  
sc_cr_b <- readRDS("data/sc_cr_b.RDS") # Smita 
```

```{r libraries, include=FALSE}
library(ggplot2)
library(dplyr)
library(maps)
library(mapdata)
library(ggmap)
library(plotly)
```

# Background   
  
------------------------------------------  

### Data and Approach  
We used IRS tax data for the state of Tennessee to review income levels by zip code, along with other financial variables, to find correlation with county level school data. We analyzed school and tax data separately, as well as their influence on each other. The data sources for our research have been included in our [Sources Cited](#sources-cited). 
  
### Cleaning the Data   
Some school districts reported a graduation rate of 0%. Obviously, this is not accurate, and were likely empty values. We removed this data as to not influence the averages per CORE Region. We also identified instances where county data did not map exactly between tax and shool data. We were able to leverage the zip code crosswalk to join these datasets, as well as some data cleansing to ensure DeKalb County was properly recognized. 
  
### Research   
[School Funding, Taxes, and Economic Growth, _An Analysis of the 50 States_](http://www.nea.org/assets/docs/HE/schoolfunding.pdf), was part of our research.  

[Dual Enrollment for TN School Districts](https://www.ingramcontent.com/news/dual-enrollment-made-more-accessible-for-tennessee-school-districts)  

[Centers of Regional Excellence](https://www.tn.gov/education/centers-of-regional-excellence.html)  

### ![](https://www.tn.gov/content/dam/tn/education/images/CORE-districts.png)   
    

# AGI and ACT Maps

------------------------------------------
As expected, a higher income from a particular county *does* result in a lower percentage of students that qualify as **"Economically Disadvantaged"** - students that qualified for free or reduced lunches.  
  
```{r Justin_2, echo = FALSE, warning = FALSE}
## Cloropleth

## Total across zip code - removes agi ranges
zip_total <- merged_df %>% 
  filter(zip_code != 0 & is.na(agi_range))

 ## Filtering and summarising subject proficiency
 chloro_df <- zip_total %>% 
   filter(is.na(agi_range)) %>% 
   dplyr::select(CORE_region, system_name, county, Pct_ED, AlgI, AlgII, Math, 
          BioI, Chemistry, Science, ACT_Composite) %>%
   group_by(county) %>% 
   summarise_all(funs(mean)) %>% 
   filter(!is.na(county))
```

```{r Justin_2b, echo = FALSE, warning = FALSE}
## Filter data to just include TN

TN_data <- map_data("state") %>% 
  filter(region =='tennessee')

TN_counties <- map_data("county") %>% 
  subset(., region == "tennessee")

TN_counties$subregion <- TN_counties$subregion %>% 
  gsub('de kalb', 'dekalb', .)

chloro_df$county_l <- sapply(chloro_df$county, tolower) %>% 
  gsub(' county','', .)

## Left join to merge polygon and county data

chloro_df <- left_join(x = TN_counties, y = chloro_df, by = c("subregion" = "county_l"))

## Switching to AGI data

agi_chloro_df <- zip_total %>% 
  filter(is.na(agi_range)) %>% 
  mutate(avg_agi = (agi_a * 1000)/return_c) %>% 
  select(CORE_region, system_name, county, avg_agi) %>%
  group_by(county) %>% 
  summarise_all(funs(mean)) %>% 
  filter(!is.na(county))

## Filter data to just include TN

agi_chloro_df$county_l <- sapply(agi_chloro_df$county, tolower) %>% 
  gsub(' county','', .)

## Left join to merge polygon and county data

agi_chloro_df <- left_join(x = TN_counties, y = agi_chloro_df, by = c("subregion" = "county_l"))

## Create maps

TN_agi_map <- ggplot() + 
  geom_polygon(data = agi_chloro_df, 
               aes(x = long, y = lat, group = group, fill = avg_agi),
               color = "white", size = 0.25) +
  coord_map() +
  scale_fill_distiller(name = "Average AGI", palette = "YlGn") +
  theme_nothing(legend = TRUE) +
  labs(title = "Average AGI") +
  theme(plot.title = element_text(hjust = 0.5)) 

TN_ed_map <- ggplot() + 
  geom_polygon(data = chloro_df, 
               aes(x = long, y = lat, group = group, fill = Pct_ED),
               color = "white", size = 0.25) +
  coord_map() +
  scale_fill_distiller(name = "Percent ED", palette = "YlGn") +
  theme_nothing(legend = TRUE) +
  labs(title = "% of Economically Disadvantaged Students") +
  theme(plot.title = element_text(hjust = 0.5))
```

<!--- consider leaflet instead of plotly, better control, better legend impact --> 

```{r ACT_county_map, include=FALSE}
color_df <- readRDS("color_df.RDS")

TN_map <- ggplot() +
  geom_polygon(data = color_df,
               aes(x = long, y = lat, group = group, fill = Average_ACT_Composite),
               color = "white", size = 0.25) +
  coord_map() +
  scale_fill_distiller(name="ACT Scores", palette = "YlGn") +
  theme_nothing(legend = TRUE) +
  labs(title = "Average ACT Composite Scores by County") +
  theme(plot.title = element_text(hjust = 0.5))

map1 <- TN_agi_map
map2 <- TN_ed_map
map3 <- TN_map
```

------------------------------------------
## Maps Row {data-width = 60}
### Adjusted Gross Income  
```{r map1, echo=FALSE, message=FALSE, warning=FALSE}
map1 <- ggplotly(map1, width = 565, height = 155)
map1
```   

### Economically Disadvantaged  
```{r map2, echo=FALSE, message=FALSE, warning=FALSE}
map2 <- ggplotly(map2, width = 565, height = 155)
map2
```   

### Average ACT Composite Scores  
```{r map3, echo=FALSE, message=FALSE, warning=FALSE}
map3 <- ggplotly(map3, width = 565, height = 155)
map3
```   
   
.  
   
## Text Row {data-width = 20}
### Adjusted Gross Income  
As you can see, Williamson County is highlighted with having the highest average AGI per tax return filing, at $106,874. Other counties highlighted appear to be located near 3 other major cities - Knoxville, Memphis, Chattanooga.
   
### Economically Disadvantaged  
The Economically disavantaged areas don't appear to be as drastically separated. It seems the economically dxisadvantaged county shading is more gradual as you get further from the major cities. This is not absolute, as Davidson County / Nashville, falls in the much darker region having 75% economically disadvantaged. 
  
### Average ACT Composite Scores  
With the average ACT composite scores by county, Williamson County is again highlighted and has the highest scores, with an average of 23.8. Unlike the other maps, scores do not appear to have a pattern or relationship across the state or in relation to the 4 major cities. 
   
  
## Table Row {data-width = 20}
### Average AGI and ACT Scores by County  
``` {r kabletest, echo=FALSE, message=FALSE, warning=FALSE}
#color_df$Average_ACT_Composite <- round(color_df$Average_ACT_Composite, digits = 3) 

act_agi_table <- merge(x = color_df, y = agi_chloro_df, by = "subregion", all = TRUE) %>% 
 select(County_Name, avg_agi, Average_ACT_Composite) %>% 
 group_by(County_Name) %>% 
 unique()
  

act_agi_table %>%
  knitr::kable(format = "markdown",
  row.names = FALSE, col.names = c("County", "Average AGI", "Average ACT Score"))

```

# Correlations  

## Background   

### Insights   {data-height=100}  
The correlations allowed for prediction of ACT scores for DeKalb County

### Map     {data-height=800}  
  
```{r corr}
library(PerformanceAnalytics)

ACME_corr <- readRDS("ACME_corr.RDS")
chart.Correlation(ACME_corr, histogram=TRUE, pch=21)

```

# Sources

## left blank   {data-width=100}

## left center  

### Packages Used  
 *  readxl  
 *  ggplot2  
 *  knitr  
 *  dplyr  
 *  tidyr  
 *  PerformanceAnalytics  
 *  maps  
 *  mapdata  
 *  mapproj  
 *  ggmap  
 *  plotly  
 *  GGally  
 *  corrplot  
 *  MASS  
 *  tidyverse  
 *  gapminder  

## right
### Data Links  
*  [IRS Sales Tax Data](https://www.irs.gov/statistics/soi-tax-stats-individual-income-tax-statistics-zip-code-data-soi)    
*  [School Achievement Data](https://www.tn.gov/education/data/data-downloads.html)   
*  [Crosswalk, Zip to District](https://www.tn.gov/education/data/data-downloads.html)  
*  [Department of Education, Data Definitions](https://www.tn.gov/content/dam/tn/education/data/data_definitions.pdf)  
  
### Github  
[DataScienceBS](http://www.github.com/DataScienceBS)    
   
    
    
<!-- ![](https://images-na.ssl-images-amazon.com/images/I/41DV9duaRWL.jpg)  --> 
    
## right blank     {data-width=100}

